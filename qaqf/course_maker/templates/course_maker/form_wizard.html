<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Creation Wizard</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KE6tbwr25q5Fv7uME6BU6h2HhtXb1wFTnxJVZb8VSKq0kTgyXXpVqvBgKjeWCqH3" crossorigin="anonymous">

    <!-- jQuery for AJAX -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        #ollama-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Ollama Status Indicator -->
    <div id="ollama-status">Checking Ollama status...</div>

    <!-- Main Content -->
    <div class="container mt-5">
         {% block content %}
        {% endblock %}
    </div>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ wizard.management_form }}

        <!-- This renders the current stepâ€™s form fields -->
        {{ form.as_p }}

        <div class="wizard-navigation">
            {% if wizard.steps.prev %}
                <button type="submit" name="wizard_goto_step" value="{{ wizard.steps.prev }}">Previous</button>
            {% endif %}

            {% if wizard.steps.current == wizard.steps.last %}
                <button type="submit">Finish</button>
            {% else %}
                <button type="submit">Next</button>
            {% endif %}
        </div>
    </form>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2zNkS7hVDPHJo6mgkJmV6EZG8rryUCu1pM5rV3cjjIUqfRxXPG5QK7tmYp" crossorigin="anonymous"></script>

    <script>
        function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    function checkOllamaStatus() {
        $.ajax({
            url: "{% url 'ollama_status' %}",
            method: "GET",
            success: function(data) {
                let statusElement = document.getElementById("ollama-status");
                if (data.status === "running") {
                    statusElement.textContent = "Ollama is running";
                    statusElement.style.color = "green";
                } else if (data.status === "stopped") {
                    statusElement.textContent = "Ollama is stopped";
                    statusElement.style.color = "red";

                    // Attempt to start Ollama if not running
                    startOllamaService();
                } else {
                    statusElement.textContent = "Error checking Ollama status";
                    statusElement.style.color = "orange";
                }
            },
            error: function() {
                let statusElement = document.getElementById("ollama-status");
                statusElement.textContent = "Failed to connect to Ollama service";
                statusElement.style.color = "orange";
            }
        });
    }

    function startOllamaService() {
    $.ajax({
        url: "{% url 'run_ollama' %}",
        method: "POST",
        headers: {
            'X-CSRFToken': csrftoken
        },
        success: function(data) {
            let statusElement = document.getElementById("ollama-status");
            if (data.status === "started") {
                statusElement.textContent = "Ollama started successfully";
                statusElement.style.color = "green";
            }
        },
        error: function(xhr) {
            let statusElement = document.getElementById("ollama-status");
            statusElement.textContent = "Failed to start Ollama: " + xhr.responseJSON.message;
            statusElement.style.color = "orange";
        }
    });
}

    // Call the function initially and set an interval to check periodically
    checkOllamaStatus();
    setInterval(checkOllamaStatus, 5000); // Check every 5 seconds

</script>

</body>
</html>
